# Issue: 实现代码浏览器功能

## 元数据

| 字段 | 内容 |
|------|------|
| **文件名** | 20260106-实现代码浏览器功能.md |
| **创建时间** | 2026-01-06 |
| **状态** | ✅ 已完成 |
| **优先级** | 🔴 P0 |
| **负责人** | Pi Agent |
| **预计工时** | 4-6 小时 |

## Goal

实现一个"代码浏览器"桌面应用，支持目录树浏览、Monaco Editor 只读查看、跳转高亮、行批注功能。

## 背景/问题

根据 workhub 角色定义，需要实现一个完整的代码浏览器应用，包含：
- 左侧目录树（懒加载）
- 右侧 Monaco Editor（只读模式）
- 跳转与高亮
- 行批注/装饰

## 验收标准 (Acceptance Criteria)

- [x] WHEN 用户选择根目录，系统 SHALL 显示目录树（至少展开两层不报错）
- [x] WHEN 用户点击文本文件，系统 SHALL 在 Monaco 显示内容
- [x] WHEN 调用 jumpTo(file, line)，系统 SHALL 滚动到指定行并高亮
- [x] WHEN 调用 setAnnotations([{line,message,kind}])，系统 SHALL 在对应行显示 glyph 图标且 hover 可见
- [x] WHERE Monaco 编辑器，系统 SHALL 是只读模式（键盘输入不改变内容）
- [x] IF 传入 "../" 之类路径，系统 SHALL 返回错误（安全校验生效）

## 实施阶段

### Phase 1: 基础设施
- [x] 设计项目结构
- [x] 安装 Monaco Editor 依赖
- [x] 实现 Rust 后端基础命令

### Phase 2: Rust 后端
- [x] 实现 set_root_dir 命令
- [x] 实现 list_dir 命令（懒加载）
- [x] 实现 read_file 命令（大文件保护）
- [x] 实现路径安全校验

### Phase 3: React 前端 - 目录树
- [x] 实现目录树组件（FileSystemTree）
- [x] 实现懒加载逻辑
- [x] 实现文件点击回调

### Phase 4: React 前端 - Monaco Editor
- [x] 实现 Monaco Editor 组件
- [x] 实现语言推断
- [x] 实现只读模式

### Phase 5: 高级功能
- [x] 实现 jumpTo 函数（跳转+高亮）
- [x] 实现 setAnnotations 函数（行批注）
- [x] 添加 CSS 样式

### Phase 6: 整合测试
- [x] 端到端功能测试
- [x] 安全校验测试
- [x] 性能测试

## 关键决策

| 决策 | 理由 |
|------|------|
| 使用 @monaco-editor/react | 官方 React 封装，易于集成 |
| Rust 命令 + root sandbox | 比 plugin-fs 更灵活，支持任意目录 |
| 前缀路径展示 "/" | 统一处理跨平台路径分隔符 |

## 遇到的错误

| 日期 | 错误 | 解决方案 |
|------|------|---------|
| 2026-01-06 | Generator script not found | 修复 projectRoot 路径配置 |
| 2026-01-06 | Dialog 背景透明 | 改用硬编码颜色 bg-white |
| 2026-01-06 | Select 下拉框不展开 | 重写 Select 组件，使用 Context API |
| 2026-01-06 | Button 没有样式 | 重写 Button 组件，使用硬编码颜色 |
| 2026-01-06 | React 不识别 isActive 属性 | 移除 DOM 元素上的 isActive 属性 |
| 2026-01-06 | TreeView 组件类型错误 | 修复 TreeNode 类型定义 |
| 2026-01-06 | Monaco Editor jumpToLine 未定义 | 修复方法暴露方式 |
| 2026-01-06 | Monaco Editor CDN source map 404 | 拦截 fetch 和 XMLHttpRequest 阻止 .map 请求 |

## 相关资源

- 参考文档: `docs/issues/xxx.md`
- 技术栈: Rust + Tauri 2.x + React + Monaco Editor

## Notes

项目结构参考：
```
client/
├── src-tauri/src/          # Rust 后端
│   ├── code_browser.rs     # 代码浏览器命令
│   └── main.rs
├── src/                    # React 前端
│   ├── components/
│   │   ├── CodeBrowser/    # 代码浏览器主组件
│   │   ├── FileSystemTree/ # 文件系统树组件
│   │   ├── MonacoEditor/   # Monaco 编辑器组件
│   │   └── ui/
│   ├── stores/             # 状态管理
│   └── utils/              # 工具函数
└── package.json
```

### 已实现功能

#### Rust 后端
- ✅ `set_root_dir` - 设置项目根目录
- ✅ `list_dir` - 列出目录内容（懒加载）
- ✅ `read_file` - 读取文件内容（10MB 大文件保护）
- ✅ `get_root_dir` - 获取根目录路径
- ✅ 路径安全校验（防止 `../` 路径穿越）

#### React 前端
- ✅ `FileSystemTree` - 目录树组件（懒加载、展开/收起）
- ✅ `MonacoEditor` - Monaco 编辑器组件
- ✅ `CodeBrowser` - 主界面组件
- ✅ 语言推断（支持 20+ 种语言）
- ✅ 只读模式
- ✅ `jumpToLine` - 跳转并高亮指定行
- ✅ `setAnnotations` - 行批注功能（info/warn/todo）
- ✅ CSS 样式（高亮、批注图标）
- ✅ 默认根目录设置
- ✅ 视图切换（CodeMap / Code Browser）

#### 样式修复
- ✅ Dialog 组件 - 白色背景
- ✅ Select 组件 - 正常展开/收起
- ✅ Button 组件 - 蓝色/灰色样式
- ✅ Monaco Editor - 批注样式（info/warn/todo）

### 技术亮点
- 使用 Rust 命令 + root sandbox 实现安全的文件系统访问
- 懒加载目录树，避免大仓库卡顿
- Monaco Editor 只读模式 + 跳转高亮 + 行批注
- 拦截 source map 请求避免 CDN 404 错误

---

## Status 更新日志

- **2026-01-06 23:23**: 状态变更 → 🚧 进行中，开始实现代码浏览器功能
- **2026-01-07 01:39**: 状态变更 → ✅ 已完成，所有功能实现完成
- **2026-01-07 01:43**: 添加文件图标功能
- **2026-01-07 01:45**: 添加文件夹图标功能
- **2026-01-07 01:50**: 状态变更 → ✅ 已完成，所有功能通过测试
- **2026-01-07 01:51**: 状态变更 → ✅ 已完成，修复所有错误，图标正常显示
