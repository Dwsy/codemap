{
  "schemaVersion": 1,
  "title": "API 请求处理流程",
  "description": "从 HTTP 请求到达服务器到响应返回的完整处理链路",
  "mermaidDiagram": "graph TB\n    subgraph 客户端\n        A[HTTP 请求]\n    end\n    subgraph 中间件层\n        B[CORS] --> C[Logger]\n        C --> D[Auth]\n        D -->|通过| E[RateLimit]\n        D -->|失败| ERR1[401 Unauthorized]\n        E -->|超限| ERR2[429 Too Many]\n    end\n    subgraph 路由层\n        E --> F[路由匹配]\n        F --> G[参数验证]\n        G -->|失败| ERR3[400 Bad Request]\n    end\n    subgraph 控制器层\n        G --> H[Controller.handle]\n        H --> I[Service.execute]\n    end\n    subgraph 数据访问层\n        I --> J[Repository.query]\n        J --> K[数据库]\n    end\n    subgraph 响应层\n        K --> L[格式化响应]\n        L --> M[返回 JSON]\n    end",
  "traces": [
    {
      "id": "1",
      "title": "中间件处理",
      "description": "请求经过一系列中间件进行预处理",
      "locations": [
        {
          "id": "1a",
          "path": "/src/middleware/cors.ts",
          "lineNumber": 12,
          "lineContent": "export const cors = (req: Request, res: Response, next: NextFunction) => { res.header('Access-Control-Allow-Origin', '*'); next(); };",
          "title": "CORS 处理",
          "description": "处理跨域资源共享"
        },
        {
          "id": "1b",
          "path": "/src/middleware/logger.ts",
          "lineNumber": 8,
          "lineContent": "export const logger = (req: Request, res: Response, next: NextFunction) => { console.log(`${req.method} ${req.path}`); next(); };",
          "title": "请求日志",
          "description": "记录请求信息"
        },
        {
          "id": "1c",
          "path": "/src/middleware/auth.ts",
          "lineNumber": 15,
          "lineContent": "export const auth = (req: Request, res: Response, next: NextFunction) => { const token = req.headers.authorization; if (!token) return res.status(401).json({ error: '未授权' }); try { const decoded = jwt.verify(token); req.user = decoded; next(); } catch (e) { res.status(401).json({ error: 'Token 无效' }); } };",
          "title": "认证中间件",
          "description": "验证 JWT Token"
        },
        {
          "id": "1d",
          "path": "/src/middleware/rateLimit.ts",
          "lineNumber": 20,
          "lineContent": "export const rateLimit = (req: Request, res: Response, next: NextFunction) => { const key = req.ip; const count = requests.get(key) || 0; if (count > 100) return res.status(429).json({ error: '请求过多' }); requests.set(key, count + 1); next(); };",
          "title": "限流中间件",
          "description": "限制请求频率"
        }
      ],
      "traceTextDiagram": "中间件链\n├── CORS < -- 1a\n├── Logger < -- 1b\n├── Auth < -- 1c\n└── RateLimit < -- 1d",
      "traceGuide": "## Motivation\n\n通过中间件实现横切关注点（如认证、日志、限流），保持控制器代码简洁。\n\n## Details\n\n请求首先经过 CORS 处理 [1a]，允许跨域访问。\n\n然后记录请求日志 [1b]，用于调试和监控。\n\n认证中间件验证 JWT Token [1c]，未授权则返回 401。\n\n最后检查请求频率 [1d]，超过限制则返回 429。\n\n中间件执行顺序：\n\n```infographic\ninfographic list-row-horizontal-icon-arrow\ndata\n  title 中间件链\n  lists\n    - label CORS\n      desc 跨域处理\n      icon globe\n    - label Logger\n      desc 日志记录\n      icon file\n    - label Auth\n      desc 身份认证\n      icon lock\n    - label RateLimit\n      desc 流量限制\n      icon clock\ntheme\n  palette\n    - #3b82f6\n    - #10b981\n    - #f97316\n    - #8b5cf6\n```"
    },
    {
      "id": "2",
      "title": "路由匹配与参数验证",
      "description": "将请求路由到对应的处理器并验证参数",
      "locations": [
        {
          "id": "2a",
          "path": "/src/routes/user.ts",
          "lineNumber": 10,
          "lineContent": "router.get('/users/:id', validateParams({ id: 'string' }), UserController.getUser);",
          "title": "路由定义",
          "description": "定义路由和验证规则"
        },
        {
          "id": "2b",
          "path": "/src/middleware/validate.ts",
          "lineNumber": 18,
          "lineContent": "export const validateParams = (schema: any) => (req: Request, res: Response, next: NextFunction) => { const errors = []; for (const [key, type] of Object.entries(schema)) { if (typeof req.params[key] !== type) errors.push(`${key} 必须是 ${type}`); } if (errors.length > 0) return res.status(400).json({ errors }); next(); };",
          "title": "参数验证",
          "description": "验证路径参数格式"
        }
      ],
      "traceTextDiagram": "路由层\n├── 路由匹配 < -- 2a\n└── 参数验证 < -- 2b",
      "traceGuide": "## Motivation\n\n确保请求参数格式正确，避免无效请求进入业务逻辑。\n\n## Details\n\n路由框架根据 URL 路径和 HTTP 方法匹配处理器 [2a]。\n\n参数验证中间件检查参数类型 [2b]，不符合则返回 400 错误。"
    },
    {
      "id": "3",
      "title": "控制器处理",
      "description": "控制器协调服务层完成业务逻辑",
      "locations": [
        {
          "id": "3a",
          "path": "/src/controllers/UserController.ts",
          "lineNumber": 25,
          "lineContent": "async getUser(req: Request, res: Response) { const user = await this.userService.getById(req.params.id); if (!user) return res.status(404).json({ error: '用户不存在' }); res.json(user); }",
          "title": "控制器方法",
          "description": "处理获取用户请求"
        }
      ],
      "traceTextDiagram": "控制器\n└── getUser < -- 3a",
      "traceGuide": "## Motivation\n\n控制器作为请求入口，协调服务层完成业务逻辑，不包含复杂业务逻辑。\n\n## Details\n\n控制器调用服务层获取数据 [3a]，根据结果返回响应（成功返回数据，失败返回 404）。"
    },
    {
      "id": "4",
      "title": "服务层与数据访问",
      "description": "服务层执行业务逻辑，数据访问层与数据库交互",
      "locations": [
        {
          "id": "4a",
          "path": "/src/services/UserService.ts",
          "lineNumber": 18,
          "lineContent": "async getById(id: string) { return await this.userRepo.findById(id); }",
          "title": "服务方法",
          "description": "查询用户服务"
        },
        {
          "id": "4b",
          "path": "/src/repositories/UserRepository.ts",
          "lineNumber": 15,
          "lineContent": "async findById(id: string) { return await this.db.query('SELECT * FROM users WHERE id = ?', [id]); }",
          "title": "仓储方法",
          "description": "数据库查询"
        }
      ],
      "traceTextDiagram": "数据层\n├── Service.getById < -- 4a\n└── Repository.findById < -- 4b",
      "traceGuide": "## Motivation\n\n分离业务逻辑和数据访问，提高代码可测试性和可维护性。\n\n## Details\n\n服务层定义业务逻辑 [4a]，调用仓储层访问数据库。\n\n仓储层执行 SQL 查询 [4b]，返回查询结果。"
    }
  ]
}