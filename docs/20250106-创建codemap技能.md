# 创建 CodeMap 技能及 Rust+Tauri 客户端

> 创建完整的代码流程分析与可视化工具，支持本地文件分析、历史版本管理、导入导出等功能。

## 背景与目的 (Why)

基于用户提供的 codemap 提示词，创建一个完整的技能和客户端应用，用于：
1. 分析代码执行流程，自动识别关键节点
2. 生成结构化的 CodeMap JSON 输出
3. 提供多种可视化形式（Mermaid 图、文本图、Markdown 指南）
4. 支持历史版本管理和分享功能
5. 所有数据存储在项目的 `docs/.codemap/` 目录，便于版本控制

## 变更内容概述 (What)

### 1. 技能文档创建
- **位置**: `~/.pi/agent/skills/codemap/SKILL.md`
- **内容**: 完整的技能定义，包含功能特性、API 文档、使用指南

### 2. Rust + Tauri 客户端
- **位置**: `~/.pi/agent/skills/codemap/client/`
- **架构**:
  - **后端** (Rust): 代码分析、JSON 生成、文件存储
  - **前端** (Web): 目录树、可视化展示、历史管理

### 3. 核心功能实现

#### 后端模块
- `main.rs`: Tauri 应用入口
- `commands.rs`: Tauri 命令 API（8 个命令）
- `analyzer.rs`: 代码分析逻辑
- `codemap.rs`: CodeMap 数据结构
- `storage.rs`: 基于文件系统的存储

#### 前端模块
- `index.html`: 主界面布局
- `app.js`: 应用逻辑（16773 字节）
- `styles/app.css`: 样式定义（11040 字节）

### 4. 数据存储设计
- **目录**: `docs/.codemap/`
- **结构**:
  - `index.json`: CodeMap 索引
  - `codemaps/`: CodeMap 数据文件
  - `exports/`: 导出文件
  - `cache/`: 缓存目录

### 5. 支持的功能
- ✅ 代码流程分析（识别 Controller、Service、Mapper）
- ✅ 三种可视化输出（Mermaid、文本图、Markdown）
- ✅ 交互式目录树（多文件选择）
- ✅ 历史版本管理（CRUD）
- ✅ 导入导出（JSON、Markdown、HTML）
- ✅ 分享功能（自包含 HTML）

## 关联 Issue 与 ToDo 条目 (Links)
- **Issues:** `docs/issues/20250106-创建codemap技能.md`

## 测试与验证结果 (Test Result)

### 已完成的功能
- [x] 技能文档编写完成
- [x] Rust 后端代码结构完整
- [x] 前端界面设计完整
- [x] 数据存储方案设计完成

### 待测试功能
- [ ] 集成测试：前后端联调
- [ ] 功能测试：代码分析准确性
- [ ] 可视化测试：Mermaid 渲染效果
- [ ] 导出测试：各格式导出功能
- [ ] 存储测试：文件读写操作

### 测试计划
1. 安装依赖：`cd client && npm install`
2. 启动开发模式：`npm run dev`
3. 选择测试项目的代码文件
4. 输入查询并分析
5. 验证可视化输出
6. 测试保存/加载历史版本
7. 测试导出功能

## 风险与影响评估 (Risk Assessment)

### 技术风险
- **Mermaid 渲染**: 依赖 CDN，可能影响离线使用
  - **缓解**: 可配置本地 mermaid.js
- **代码解析准确性**: 基于模式匹配，可能遗漏复杂逻辑
  - **缓解**: 支持手动编辑和扩展识别规则

### 使用风险
- **文件权限**: 需要读写 `docs/.codemap/` 目录
  - **缓解**: 提供权限检查和错误提示
- **大文件性能**: 分析大型项目可能较慢
  - **缓解**: 添加进度提示和取消功能

### 影响范围
- 新增技能：`~/.pi/agent/skills/codemap/`
- 新增数据目录：`docs/.codemap/`（项目级别）
- 不影响现有功能

## 回滚方案 (Rollback Plan)

### 如果需要回滚
1. 删除技能目录：`rm -rf ~/.pi/agent/skills/codemap/`
2. 删除项目数据：`rm -rf docs/.codemap/`
3. 清理 Issue：`rm docs/issues/20250106-创建codemap技能.md`

### 数据备份建议
- 定期备份 `docs/.codemap/` 目录
- CodeMap 文件采用 JSON 格式，易于版本控制
- 导出的 HTML 文件可独立保存

## 后续优化建议

### 短期优化
- [ ] 添加代码复杂度分析
- [ ] 支持更多编程语言
- [ ] 添加搜索和过滤功能
- [ ] 实现版本对比功能

### 长期优化
- [ ] 集成 AI 智能建议
- [ ] 支持团队协作（云端同步）
- [ ] 添加插件系统
- [ ] 支持自定义分析规则

## 使用示例

### 启动应用
```bash
cd ~/.pi/agent/skills/codemap/client
npm install
npm run dev
```

### 分析代码流程
1. 在目录树中选择相关文件（Controller、Service、Mapper）
2. 输入查询：`用户登录全流程`
3. 点击"分析"按钮
4. 查看三种可视化输出
5. 点击"保存"保存到历史

### 导出分享
1. 选择已保存的 CodeMap
2. 点击"导出"
3. 选择 HTML 格式
4. 发送给同事，直接在浏览器打开

## 技术栈总结

| 层级 | 技术 | 说明 |
|------|------|------|
| 后端 | Rust + Tauri 2.0 | 跨平台桌面应用框架 |
| 前端 | Vanilla JS + HTML + CSS | 无框架依赖 |
| 可视化 | mermaid.js + marked.js | 流程图和 Markdown 渲染 |
| 存储 | 文件系统 (JSON) | 存储在 `docs/.codemap/` |
| 构建工具 | Tauri CLI + npm | 开发和构建工具链 |

## 文件清单

### 技能文件
- `~/.pi/agent/skills/codemap/SKILL.md` (8.2 KB)
- `~/.pi/agent/skills/codemap/README.md` (4.3 KB)

### 客户端后端
- `client/src-tauri/Cargo.toml` (606 B)
- `client/src-tauri/tauri.conf.json` (635 B)
- `client/src-tauri/build.rs` (38 B)
- `client/src-tauri/src/main.rs` (1.1 KB)
- `client/src-tauri/src/commands.rs` (5.8 KB)
- `client/src-tauri/src/analyzer.rs` (11.5 KB)
- `client/src-tauri/src/codemap.rs` (2.6 KB)
- `client/src-tauri/src/storage.rs` (12.5 KB)

### 客户端前端
- `client/package.json` (291 B)
- `client/src/index.html` (8.2 KB)
- `client/src/app.js` (16.8 KB)
- `client/src/styles/app.css` (11.0 KB)

**总计**: ~83 KB 代码和文档

## 结论

CodeMap 技能和客户端应用已完成开发和文档编写。核心功能已全部实现，待进行集成测试和功能验证。数据存储采用基于文件系统的方案，便于版本控制和备份，符合 Workhub 的文档治理规范。