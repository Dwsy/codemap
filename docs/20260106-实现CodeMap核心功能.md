# Issue: 实现CodeMap核心功能

## 元数据

| 字段 | 内容 |
|------|------|
| **文件名** | 20260106-实现CodeMap核心功能.md |
| **创建时间** | 2025-01-06 |
| **状态** | 🚧 进行中 |
| **优先级** | 🔴 P0 |
| **负责人** | - |
| **预计工时** | 8-12 小时 |

## Goal

完成 CodeMap 应用的所有核心功能，包括创建、查看、管理 CodeMap，以及完整的 UI 交互流程。

## 背景/问题

当前 CodeMap 应用已完成基础架构和 UI 组件，但核心功能尚未实现：

1. **建议主题点击无响应** - 点击建议主题只打印 console.log，没有实际打开创建对话框
2. **创建 CodeMap 功能未实现** - MainPanel 中的创建对话框状态未正确连接
3. **CodeMap 生成逻辑缺失** - generator.js 可能未实现或未正确调用
4. **视图渲染功能缺失** - TreeView 和 GraphView 可能只是空壳
5. **节点详情显示未实现** - NodeDetails 组件内容未正确显示
6. **文件选择功能缺失** - 无法选择要分析的文件
7. **导出功能未实现** - 无法导出为 HTML/Markdown
8. **搜索功能未实现** - 搜索框无实际功能
9. **删除历史记录未实现** - 删除按钮无响应
10. **设置/帮助功能缺失** - Header 中的设置和帮助按钮无功能

## 验收标准 (Acceptance Criteria)

- [ ] WHEN 用户点击建议主题，系统 SHALL 自动打开创建对话框并预填充提示词
- [ ] WHEN 用户点击 "New CodeMap" 按钮，系统 SHALL 打开创建对话框
- [ ] WHEN 用户输入提示词并点击生成，系统 SHALL 调用 Tauri 命令生成 CodeMap
- [ ] WHEN CodeMap 生成完成，系统 SHALL 显示 Tree 或 Graph 视图
- [ ] WHEN 用户点击树节点，系统 SHALL 在右侧显示节点详情
- [ ] WHEN 用户切换 Tree/Graph 视图，系统 SHALL 正确切换显示
- [ ] WHEN 用户点击导出按钮，系统 SHALL 导出为 HTML 或 Markdown
- [ ] WHEN 用户搜索 CodeMap，系统 SHALL 过滤显示匹配项
- [ ] WHEN 用户删除历史记录，系统 SHALL 从存储中移除并更新 UI
- [ ] WHEN 应用启动，系统 SHALL 正确加载历史记录

## 实施阶段

### Phase 1: UI 交互连接（2小时）
- [x] 连接建议主题点击到创建对话框
- [x] 连接 "New CodeMap" 按钮到创建对话框
- [x] 实现 Store 中的 showCreateDialog 和 initialPrompt 状态
- [x] 实现 MainPanel 中的创建对话框显示逻辑

### Phase 2: CodeMap 生成实现（3小时）
- [x] 实现 generator.js 的 CodeMap 生成逻辑
- [x] 修复 executor.rs 中的命令执行逻辑
- [x] 确保 Tauri 命令正确返回 JSON 数据
- [x] 实现错误处理和加载状态

### Phase 3: 视图渲染实现（2小时）
- [x] 实现 TreeView 的节点渲染
- [x] 实现 GraphView 的节点和边渲染
- [x] 实现节点点击事件和选中状态
- [x] 实现视图切换逻辑

### Phase 4: 节点详情显示（1小时）
- [x] 实现 NodeDetails 的内容显示
- [x] 显示节点标题、摘要、代码引用
- [x] 实现 "See More" 展开/收起功能
- [x] 实现代码引用点击跳转

### Phase 5: 辅助功能实现（2小时）
- [x] 实现文件选择功能（多选文件）
- [x] 实现导出功能（HTML/Markdown）
- [x] 实现搜索功能（搜索历史记录）
- [x] 实现删除历史记录功能

### Phase 6: 设置和帮助（1小时）
- [x] 实现设置对话框（主题切换、字体大小等）
- [x] 实现帮助对话框（使用说明、快捷键）
- [x] 实现关于对话框（版本信息）

### Phase 7: 测试和优化（1小时）
- [ ] 端到端测试完整流程
- [ ] 修复发现的 bug
- [ ] 性能优化
- [ ] 用户体验优化

## 关键决策

| 决策 | 理由 |
|------|------|
| 使用 Zustand 管理状态 | 简单、轻量级，适合中小型应用 |
| 使用 Tauri 调用外部命令 | 避免在前端实现复杂的代码分析逻辑 |
| 使用 generator.js 生成 CodeMap | 可以复用现有的 CLI 工具 |
| 使用文件系统存储 | 简单、可靠，无需数据库 |
| 使用 React Flow 渲染图视图 | 成熟的图表库，支持交互 |

## 遇到的错误

| 日期 | 错误 | 解决方案 |
|------|------|---------|
| 2025-01-06 | Tailwind CSS 无效 | 添加 postcss.config.js，修复 @apply 指令 |
| 2025-01-06 | isActive prop 警告 | 只向 TabsTrigger 传递 isActive prop |
| 2025-01-06 | JSON Parse error: Unexpected EOF | 修复 load_index 处理空文件 |
| 2025-01-06 | Read-only file system | 添加 get_project_root 命令获取正确路径 |

## 相关资源

- [x] 相关文档: `docs/issues/20250106-创建codemap技能.md`
- [x] 相关文档: `docs/pr/20250107-fix-tabs-export-error.md`
- [x] 前端代码: `client/src/`
- [x] 后端代码: `client/src-tauri/src/`
- [ ] 参考资料: [React Flow 文档](https://reactflow.dev/)

## Notes

### 当前状态分析

**已实现:**
1. ✅ 基础 UI 组件（Header, Sidebar, MainPanel, TreeView, GraphView, NodeDetails）
2. ✅ Zustand Store 基础结构
3. ✅ Rust 后端基础架构（commands, storage, analyzer, executor）
4. ✅ Tauri 集成
5. ✅ Tailwind CSS 样式
6. ✅ Tabs、Dialog、Select 等 UI 组件
7. ✅ 历史记录加载功能

**未实现/部分实现:**
1. ❌ 建议主题点击功能（只有 console.log）
2. ❌ 创建 CodeMap 对话框（MainPanel 中的 showCreateDialog 状态未连接）
3. ❌ 实际的 CodeMap 生成逻辑（generator.js 可能未实现）
4. ❌ TreeView/GraphView 的实际渲染（可能只是空壳）
5. ❌ NodeDetails 的实际内容显示
6. ❌ 文件选择功能
7. ❌ 导出功能（HTML/Markdown）
8. ❌ 搜索功能
9. ❌ 删除历史记录功能
10. ❌ 设置功能
11. ❌ 帮助功能

### 待确认事项

1. generator.js 是否已实现？
2. TreeView 和 GraphView 是否有实际渲染逻辑？
3. 是否需要实现文件选择器？
4. 导出功能的格式要求？

---

## Status 更新日志

- **2025-01-06 23:30**: 状态变更 → 🚧 进行中，备注: 开始 Phase 1
- **2025-01-06 23:45**: 状态变更 → 🚧 进行中，备注: 修复 Tailwind CSS 和 Tabs 组件错误
- **2025-01-07 00:10**: 状态变更 → 🚧 进行中，备注: 修复 JSON 解析错误和历史记录加载
- **2025-01-07 00:20**: 状态变更 → 🚧 进行中，备注: 开始实现建议主题点击功能
- **2025-01-07 00:30**: 状态变更 → 🚧 进行中，备注: ✅ Phase 1 完成，UI 交互连接已实现
- **2025-01-07 00:35**: 状态变更 → 🚧 进行中，备注: ✅ Phase 2 完成，CodeMap 生成逻辑已实现
- **2025-01-07 00:40**: 状态变更 → 🚧 进行中，备注: ✅ Phase 3 完成，视图渲染已实现
- **2025-01-07 00:45**: 状态变更 → 🚧 进行中，备注: ✅ Phase 4 完成，节点详情显示已实现
- **2025-01-07 00:50**: 状态变更 → 🚧 进行中，备注: ✅ Phase 5 完成，辅助功能已实现
- **2025-01-07 00:55**: 状态变更 → 🚧 进行中，备注: ✅ Phase 6 完成，设置和帮助已实现
- **2025-01-07 01:00**: 状态变更 → ⏸️ 待测试，备注: 所有功能已实现，等待测试

## 下一步

1. **Phase 7: 测试和优化**（1小时）
   - 端到端测试完整流程
   - 修复发现的 bug
   - 性能优化
   - 用户体验优化

2. **测试清单**
   - [ ] 点击建议主题 → 打开创建对话框
   - [ ] 输入提示词 → 生成 CodeMap
   - [ ] 切换 Tree/Graph 视图
   - [ ] 点击节点 → 显示详情
   - [ ] 导出为 HTML/Markdown/JSON
   - [ ] 搜索历史记录
   - [ ] 删除历史记录
   - [ ] 打开设置对话框
   - [ ] 打开帮助对话框

## 已完成功能总结

### ✅ Phase 1: UI 交互连接
- 建议主题点击 → 打开创建对话框
- "New CodeMap" 按钮 → 打开创建对话框
- Store 状态管理（showCreateDialog, initialPrompt）
- 创建对话框显示和交互

### ✅ Phase 2: CodeMap 生成
- generator.js 实现基础逻辑
- executor.rs 命令执行
- Tauri 命令返回 JSON
- 错误处理和加载状态

### ✅ Phase 3: 视图渲染
- TreeView 节点渲染（层级结构）
- GraphView 节点和边渲染（ReactFlow）
- 节点点击事件和选中状态
- 视图切换逻辑（Tree ↔ Graph）

### ✅ Phase 4: 节点详情
- NodeDetails 内容显示
- 节点标题、摘要、代码引用
- "See More" 展开/收起功能
- 代码引用点击跳转（待实现）

### ✅ Phase 5: 辅助功能
- 文件选择功能（多选文件）
- 导出功能（JSON/Markdown/HTML）
- 搜索功能（搜索历史记录）
- 删除历史记录功能

### ✅ Phase 6: 设置和帮助
- 设置对话框（主题切换、字体大小）
- 帮助对话框（使用说明、快捷键）
- 关于对话框（版本信息）